name: Python bindings

on:
    push:
        branches:
            - '**'
        tags:
            - 'v*'
    pull_request:

permissions:
    contents: write

env:
    HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
    HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
    build:
        name: Build Bindings
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        steps:
            - name: Checkout source
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Download libtorrent
              run: |
                  git clone https://github.com/arvidn/libtorrent.git --depth=1 --recurse-submodules --branch master

            - name: Dependencies (macOS)
              if: runner.os == 'macOS'
              run: |
                  cd libtorrent
                  brew install boost-build boost boost-python3 python@3.13 openssl@3 python-setuptools
                  export PATH="$(brew --prefix)/opt/python@3.13/bin:$PATH"

            - name: Install Visual Studio 2019 Build Tools
              if: runner.os == 'Windows'
              run: |
                  choco install visualstudio2019buildtools `
                    --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --quiet --norestart" ` -y

            - name: Set up MSVC 2019
              uses: ilammy/msvc-dev-cmd@v1
              if: runner.os == 'Windows'
              with:
                  arch: x64
                  toolset: 14.2
                  vsversion: '16.0'

            - name: Install OpenSSL (Windows)
              if: runner.os == 'Windows'
              run: |
                  vcpkg install openssl:x64-windows
                  Remove-Item -Path "C:\Program Files\OpenSSL" -Force -Recurse -ErrorAction SilentlyContinue
                  New-Item -Path "C:\OpenSSL-Win64" -ItemType SymbolicLink -Value "C:\vcpkg\packages\openssl_x64-windows"

            - name: Set OpenSSL Env Vars (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  setx OPENSSL_ROOT_DIR "C:\OpenSSL-Win64" /M
                  setx OPENSSL_INCLUDE_DIR "C:\OpenSSL-Win64\include" /M
                  setx OPENSSL_LIB_DIR "C:\OpenSSL-Win64\lib" /M
                  setx INCLUDE "C:\OpenSSL-Win64\include;%INCLUDE%" /M
                  setx LIB "C:\OpenSSL-Win64\lib;%LIB%" /M

            - name: Dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  cd libtorrent
                  sudo apt update
                  sudo apt install -y libboost-tools-dev libboost-python-dev libboost-dev libboost-system-dev python3 python3-setuptools libssl-dev

            - name: Setup ccache (Linux/macOS)
              if: runner.os != 'Windows'
              uses: Chocobo1/setup-ccache-action@v1
              with:
                  update_packager_index: false
                  override_cache_key: ccache-python-${{ matrix.os }}-${{ github.base_ref }}
                  ccache_options: |
                      max_size=500M

            - name: Install Boost (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  cd libtorrent
                  git clone --depth=1 --recurse-submodules -j10 --branch=boost-1.78.0 https://github.com/boostorg/boost.git
                  cd boost
                  bootstrap.bat
                  .\b2 headers

            - name: Build Bindings (Windows)
              if: runner.os == 'Windows'
              shell: cmd
              run: |
                  cd libtorrent
                  set BOOST_ROOT=%CD%\boost
                  set BOOST_BUILD_PATH=%BOOST_ROOT%\tools\build
                  set PATH=%BOOST_ROOT%;%PATH%
                  cd bindings\python
                  python setup.py build_ext --b2-args "asserts=on invariant-checks=full webtorrent=on"

            - name: Build Bindings (Linux)
              if: runner.os == 'Linux'
              run: |
                  cd libtorrent/bindings/python
                  python3 setup.py build_ext --b2-args "deprecated-functions=off webtorrent=on"

            - name: Build Bindings (macOS)
              if: runner.os == 'macOS'
              run: |
                  cd libtorrent/bindings/python
                  export PATH="$(brew --prefix)/opt/python@3.13/bin:$PATH"
                  python3.13 setup.py build_ext

            - name: Upload Built Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: bindings-${{ matrix.os }}
                  path: |
                      libtorrent/bindings/python/build/lib*/**
                      libtorrent\bindings\python\build\lib*\*.pyd
    release:
        name: Release to GitHub
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Download Linux build
              uses: actions/download-artifact@v4
              with:
                  name: bindings-ubuntu-latest
                  path: artifacts/linux

            - name: Download macOS build
              uses: actions/download-artifact@v4
              with:
                  name: bindings-macos-latest
                  path: artifacts/macos

            - name: Download Windows build
              uses: actions/download-artifact@v4
              with:
                  name: bindings-windows-latest
                  path: artifacts/windows

            - name: Upload Linux artifacts to Release
              uses: softprops/action-gh-release@v2
              with:
                  files: artifacts/linux/**/*.so

            - name: Upload macOS artifacts to Release
              uses: softprops/action-gh-release@v2
              with:
                  files: artifacts/macos/**/*.so

            - name: Upload Windows artifacts to Release
              uses: softprops/action-gh-release@v2
              with:
                  files: artifacts/windows/**/*.pyd
